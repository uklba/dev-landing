/**
 * WHO Child Growth Standards
 * Simplified LMS Parameters (L, M, S) for Weight-for-age and Height-for-age
 * Data source approximation for demonstration purposes.
 * 
 * L = Box-Cox power
 * M = Median
 * S = Coefficient of variation
 * 
 * Formula for Z-score:
 * Z = ((value / M)^L - 1) / (L * S)
 * if L == 0: Z = ln(value / M) / S
 */

const WHO_DATA = {
    boys: {
        weight: {
            // Month: [L, M, S]
            0: [0.1815, 3.346, 0.1265],
            1: [0.1066, 4.471, 0.1235],
            2: [0.0682, 5.600, 0.1197],
            3: [0.0461, 6.421, 0.1168],
            4: [0.0322, 7.025, 0.1154],
            5: [0.0232, 7.536, 0.1146],
            6: [0.0177, 7.974, 0.1142],
            7: [0.0146, 8.358, 0.1139],
            8: [0.0135, 8.705, 0.1136],
            9: [0.0139, 9.023, 0.1134],
            10: [0.0152, 9.324, 0.1132],
            11: [0.0173, 9.610, 0.1131],
            12: [0.0199, 9.885, 0.1130],
            18: [0.0385, 11.396, 0.1144],
            24: [0.0450, 12.725, 0.1169],
            30: [0.0219, 13.917, 0.1196],
            36: [-0.0138, 15.029, 0.1227],
            42: [-0.0538, 16.108, 0.1259],
            48: [-0.0931, 17.165, 0.1290],
            54: [-0.1293, 18.232, 0.1319],
            60: [-0.1610, 19.330, 0.1345]
        },
        height: {
            // Month: [L, M, S]
            0: [1, 49.884, 0.0380], // L=1 for height usually means normal distribution approx
            1: [1, 54.724, 0.0356],
            2: [1, 58.422, 0.0339],
            3: [1, 61.429, 0.0328],
            4: [1, 63.886, 0.0320],
            5: [1, 65.993, 0.0315],
            6: [1, 67.624, 0.0312],
            7: [1, 69.165, 0.0310],
            8: [1, 70.606, 0.0309],
            9: [1, 71.969, 0.0308],
            10: [1, 73.281, 0.0308],
            11: [1, 74.539, 0.0308],
            12: [1, 75.748, 0.0308],
            18: [1, 82.253, 0.0315],
            24: [1, 87.838, 0.0324],
            30: [1, 92.203, 0.0335],
            36: [1, 96.115, 0.0345],
            42: [1, 99.645, 0.0355],
            48: [1, 102.83, 0.0366],
            54: [1, 105.74, 0.0376],
            60: [1, 108.45, 0.0386]
        }
    },
    girls: {
        weight: {
            // Month: [L, M, S]
            0: [0.1548, 3.232, 0.1417],
            1: [0.1297, 4.187, 0.1326],
            2: [0.1086, 5.128, 0.1260],
            3: [0.0917, 5.845, 0.1215],
            4: [0.0783, 6.417, 0.1187],
            5: [0.0673, 6.897, 0.1170],
            6: [0.0583, 7.311, 0.1160],
            7: [0.0510, 7.683, 0.1157],
            8: [0.0454, 8.026, 0.1157],
            9: [0.0416, 8.351, 0.1158],
            10: [0.0396, 8.665, 0.1161],
            11: [0.0395, 8.971, 0.1166],
            12: [0.0411, 9.273, 0.1172],
            18: [0.0711, 10.970, 0.1243],
            24: [0.0945, 12.404, 0.1324],
            30: [0.0903, 13.627, 0.1408],
            36: [0.0671, 14.673, 0.1492],
            42: [0.0355, 15.657, 0.1568],
            48: [0.0033, 16.637, 0.1633],
            54: [-0.0264, 17.653, 0.1687],
            60: [-0.0531, 18.723, 0.1732]
        },
        height: {
            0: [1, 49.148, 0.0379],
            1: [1, 53.687, 0.0364],
            2: [1, 57.067, 0.0353],
            3: [1, 59.803, 0.0345],
            4: [1, 62.093, 0.0338],
            5: [1, 64.092, 0.0334],
            6: [1, 65.869, 0.0330],
            7: [1, 67.488, 0.0328],
            8: [1, 68.995, 0.0326],
            9: [1, 70.418, 0.0325],
            10: [1, 71.777, 0.0325],
            11: [1, 73.084, 0.0325],
            12: [1, 74.347, 0.0326],
            18: [1, 80.965, 0.0337],
            24: [1, 86.444, 0.0350],
            30: [1, 90.960, 0.0363],
            36: [1, 95.064, 0.0375],
            42: [1, 98.790, 0.0387],
            48: [1, 102.16, 0.0398],
            54: [1, 105.21, 0.0409],
            60: [1, 107.96, 0.0419]
        }
    }
};

/**
 * Linear interpolation for months not exactly in the table
 */
function getLmsData(gender, type, month) {
    const dataset = WHO_DATA[gender][type];
    const months = Object.keys(dataset).map(Number).sort((a, b) => a - b);

    // Exact match
    if (dataset[month]) return dataset[month];

    // Out of bounds
    if (month < months[0]) return dataset[months[0]];
    if (month > months[months.length - 1]) return dataset[months[months.length - 1]];

    // Interpolate
    let lower = months[0];
    let upper = months[months.length - 1];

    for (let i = 0; i < months.length - 1; i++) {
        if (month >= months[i] && month <= months[i + 1]) {
            lower = months[i];
            upper = months[i + 1];
            break;
        }
    }

    const ratio = (month - lower) / (upper - lower);
    const [l1, m1, s1] = dataset[lower];
    const [l2, m2, s2] = dataset[upper];

    const l = l1 + (l2 - l1) * ratio;
    const m = m1 + (m2 - m1) * ratio;
    const s = s1 + (s2 - s1) * ratio;

    return [l, m, s];
}
